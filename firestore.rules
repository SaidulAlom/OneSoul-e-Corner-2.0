/**
 * @fileoverview Firestore Security Rules for NexusEd Application
 * @author Firebase Security Rules Architect
 *
 * @description
 * This ruleset establishes a role-based access control model. The core philosophy
 * is to make most content publicly readable while restricting all content management
 * (creation, updates, deletion) to users designated as administrators.
 *
 * Core Philosophy:
 * - Public Read Access: All users, including unauthenticated visitors, can read content.
 * - Admin-Only Writes: Only administrators can create, update, or delete content.
 * - Authenticated users can create content.
 *
 * Data Structure:
 * - /news_articles, /job_postings, /vlogs, /ebooks, /services: Content collections.
 * - /roles_admin/{uid}: Manages administrator roles. The existence of a document
 *   for a user's UID grants that user admin privileges.
 *
 * Key Security Decisions:
 * - Role Management Lockdown: The `/roles_admin` collection is not readable or
 *   writable by any client. Roles must be assigned out-of-band using the
 *   Firebase Admin SDK in a trusted server environment.
 * - No Data Shape Validation: Rules focus strictly on authorization (who can do what),
 *   not on data validation (the shape or type of content).
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ------------------------------------------------------------------------
    // Helper Functions
    // ------------------------------------------------------------------------

    function isSignedIn() {
      return request.auth != null;
    }

    // This is a more robust check for admin privileges.
    // It fetches the user's role document and checks if 'isAdmin' is true.
    function isAdmin() {
      return isSignedIn() && get(/databases/$(database)/documents/roles_admin/$(request.auth.uid)).data.isAdmin == true;
    }

    // ------------------------------------------------------------------------
    // Public Content Collections
    // ------------------------------------------------------------------------

    match /news/{articleId} {
      allow read: if true;
      allow create, update, delete: if true;
    }

    match /news_articles/{articleId} {
      allow read: if true;
      allow create: if isSignedIn();
      allow update, delete: if isAdmin();
    }

    match /job_postings/{jobId} {
      allow read: if true;
      allow create: if isSignedIn();
      allow update, delete: if isAdmin();
    }

    match /vlogs/{vlogId} {
      allow read: if true;
      allow create: if isSignedIn();
      allow update, delete: if isAdmin();
    }

    match /ebooks/{ebookId} {
      allow read: if true;
      allow create: if isSignedIn();
      allow update, delete: if isAdmin();
    }

    match /services/{serviceId} {
      allow read: if true;
      allow create: if isSignedIn();
      allow update, delete: if isAdmin();
    }

    // ------------------------------------------------------------------------
    // Role Management Rules
    // ------------------------------------------------------------------------

    match /roles_admin/{uid} {
      allow read, write: if false;
    }
  }
}
